trigger:
- master

jobs:
- job: Linux
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - script: |
      chmod +x install-latest-packer.sh
      ./install-latest-packer.sh
    displayName: 'Install packer'

  - script: mkdir output-ubuntu
    displayName: 'faking ubuntu server output for validation to succeed'

  - script: mkdir -p windows/iso && touch windows/iso/floppy.iso
    displayName: 'faking floppy generation for validation to succeed'

  - script: packer validate .
    displayName: 'Run packer validate'

- job: Windows
  pool:
    vmImage: 'windows-latest'

  steps:
  - powershell: Install-WindowsFeature -Name Hyper-V-PowerShell
    displayName: 'Install Hyper-V Powershell module'

  - powershell: |
      $ChocoInstallPath = "$env:SystemDrive\ProgramData\Chocolatey\bin"

      if (!(Test-Path $ChocoInstallPath)) {
          iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))
      }
      choco install packer
    displayName: 'Install packer'

  - powershell: ./windows/scripts/mkiso.ps1 -Source './windows/answer_files/autounattend.xml', './windows/floppy/' -OutPath './windows/iso/floppy.iso' -Force
    displayName: 'Build floppy'
